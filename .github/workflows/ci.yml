name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # Unit and integration tests with headless Hive
  test:
    name: Tests (Flutter ${{ matrix.flutter-version }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        flutter-version: ['stable', 'beta']
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ matrix.flutter-version }}
          cache: true
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Analyze code
        run: flutter analyze --no-fatal-infos
      
      - name: Check formatting
        run: dart format --set-exit-if-changed .
        continue-on-error: true
      
      - name: Run unit tests with coverage
        run: flutter test test/unit --coverage --reporter expanded
      
      - name: Run performance tests
        run: flutter test test/performance --reporter expanded
        continue-on-error: true
      
      - name: Verify critical tests are not skipped
        run: |
          # Check for skipped migration tests
          if grep -r "skip:" test/persistence/migration*.dart; then
            echo "ERROR: Migration tests should not be skipped"
            exit 1
          fi
          # Check for skipped backup/restore tests
          if grep -r "skip:" test/persistence/backups/*.dart 2>/dev/null; then
            echo "ERROR: Backup/restore tests should not be skipped"
            exit 1
          fi
        continue-on-error: false
      
      - name: Upload coverage to Codecov
        if: matrix.os == 'ubuntu-latest' && matrix.flutter-version == 'stable'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
      
      - name: Check coverage thresholds
        if: matrix.os == 'ubuntu-latest' && matrix.flutter-version == 'stable'
        run: |
          # Install lcov if not available
          if ! command -v lcov &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y lcov
          fi
          
          # Generate coverage report
          lcov --summary coverage/lcov.info > coverage_summary.txt
          
          # Extract coverage percentage
          COVERAGE=$(grep "lines......:" coverage_summary.txt | awk '{print $2}' | sed 's/%//')
          echo "Overall coverage: ${COVERAGE}%"
          
          # Check minimum threshold (60%)
          if (( $(echo "$COVERAGE < 60" | bc -l) )); then
            echo "ERROR: Coverage ${COVERAGE}% is below minimum threshold of 60%"
            exit 1
          fi
          
          # Check persistence layer coverage (70%)
          lcov --extract coverage/lcov.info '*/lib/persistence/*' --output-file coverage_persistence.info
          lcov --summary coverage_persistence.info > coverage_persistence_summary.txt || echo "No persistence coverage"
          
          if [ -f coverage_persistence_summary.txt ]; then
            PERSISTENCE_COVERAGE=$(grep "lines......:" coverage_persistence_summary.txt | awk '{print $2}' | sed 's/%//' || echo "0")
            echo "Persistence layer coverage: ${PERSISTENCE_COVERAGE}%"
            
            if (( $(echo "$PERSISTENCE_COVERAGE < 70" | bc -l) )); then
              echo "WARNING: Persistence coverage ${PERSISTENCE_COVERAGE}% is below recommended threshold of 70%"
              # Not failing build, just warning
            fi
          fi

  # Integration tests with real file system (migration/backup/restore)
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Create test data directories
        run: |
          mkdir -p test_data/hive
          mkdir -p test_data/backups
          mkdir -p test_data/migrations
      
      - name: Run migration tests
        run: flutter test test/persistence/migration*.dart --reporter expanded
      
      - name: Run backup service tests
        run: flutter test test/persistence/backups --reporter expanded
        continue-on-error: true
      
      - name: Run transaction crash tests
        run: flutter test test/fault_injection/transaction_crash_test.dart --reporter expanded
      
      - name: Run idempotency tests
        run: flutter test test/unit/idempotency --reporter expanded
      
      - name: Verify test artifacts
        run: |
          echo "Checking for test artifacts..."
          ls -la test_data/ || true
          
          # Verify no leftover Hive files (clean shutdown)
          HIVE_FILES=$(find . -name "*.hive" -o -name "*.lock" | wc -l)
          echo "Found ${HIVE_FILES} Hive files after tests"
          
          if [ $HIVE_FILES -gt 10 ]; then
            echo "WARNING: Many Hive files left after tests - possible cleanup issue"
          fi
      
      - name: Upload test artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-artifacts
          path: |
            test_data/
            *.log
          retention-days: 7

  # Audit log rotation and performance tests
  audit-tests:
    name: Audit & Security Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Run audit log tests
        run: flutter test test/unit/audit_log_service_test.dart --reporter expanded
      
      - name: Run secure erase tests
        run: flutter test test/unit/secure_erase_service_test.dart --reporter expanded
        continue-on-error: true
      
      - name: Run lock service tests
        run: flutter test test/unit/lock_service_test.dart --reporter expanded
      
      - name: Run transaction service tests
        run: flutter test test/unit/transaction_service_test.dart --reporter expanded

  # Build validation
  build:
    name: Build APK
    runs-on: ubuntu-latest
    needs: [test, integration-tests]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Build APK
        run: flutter build apk --debug
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 7